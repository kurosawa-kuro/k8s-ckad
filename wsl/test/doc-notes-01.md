  1. [kubectl run â€¦ --command ã®æµã‚Œ](#1-kubectl-run--command-ã®æµã‚Œ)  
     1-1. [--command](#1-1---command)  
     1-2. [--](#1-2---)  
     1-3. [sh -c "â€¦"](#1-3-sh--c-)  
  2. [sh ã¨ -c ã®æ„å‘³](#2-sh-ã¨--c-ã®æ„å‘³)  
     2-1. [sh](#2-1-sh)  
     2-2. [-c](#2-2--c)  
  3. [readinessProbe.exec ã®æ›¸ãæ–¹](#3-readinessprobeexec-ã®æ›¸ãæ–¹)  
     3-1. [Probe ã¯ã‚³ãƒ³ãƒ†ãƒŠå˜ä½](#3-1-probe-ã¯ã‚³ãƒ³ãƒ†ãƒŠå˜ä½)  
     3-2. [å˜ä¸€ãƒã‚¤ãƒŠãƒªå®Ÿè¡Œ](#3-2-å˜ä¸€ãƒã‚¤ãƒŠãƒªå®Ÿè¡Œ)  
     3-3. [ã‚·ã‚§ãƒ«æ©Ÿèƒ½ãŒå¿…è¦ãªã‚‰](#3-3-ã‚·ã‚§ãƒ«æ©Ÿèƒ½ãŒå¿…è¦ãªã‚‰)  
  4. [ï¼“ã¤ã®åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³](#4-ï¼“ã¤ã®åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³)  
  5. [ãã®ä»–è¦šãˆæ›¸ã](#5-ãã®ä»–è¦šãˆæ›¸ã)  
  6. [ç›´æ¥å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã®ä¾‹](#6-ç›´æ¥å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã®ä¾‹)

# CKAD è‹¦æ‰‹å…‹æœãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

-# CKAD è‹¦æ‰‹å…‹æœãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### â€œè¦šãˆã‚„ã™ã•å„ªå…ˆâ€ã§ä¸¦ã¹æ›¿ãˆãŸ kcfg

```bash
alias kcfg='kubectl get cm,secret,sa,role,pvc,svc,events -n'
```

#### ä¸¦ã¹æ›¿ãˆãƒ«ãƒ¼ãƒ«

| ãƒ–ãƒ­ãƒƒã‚¯          | ãƒªã‚½ãƒ¼ã‚¹           | è¦šãˆæ–¹                           | ã‚ˆãè¦‹ã‚‹æµã‚Œ              |
| ------------- | -------------- | ----------------------------- | ------------------- |
| **â‘  è¨­å®š**      | `cm`, `secret` | **C**onfig & **S**ecret       | ã¾ãšç’°å¢ƒå¤‰æ•°ã‚„è¨¼æ˜æ›¸ã‚’ç¢ºèª       |
| **â‘¡ èªè¨¼/RBAC** | `sa`, `role`   | **S**erviceAccount â†’ **R**ole | æ¬¡ã«èª°ãŒã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ç¢ºèª       |
| **â‘¢ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**   | `pvc`          | **P**ersistent Volume Claim   | Pod Pending ã®å®šç•ªãƒã‚§ãƒƒã‚¯ |
| **â‘£ æ¥ç¶šå£**     | `svc`          | **S**ervice                   | å¤–éƒ¨/å†…éƒ¨é€šä¿¡ãŒé€šã‚‹ã‹ç¢ºèª       |
| **â‘¤ çŠ¶æ…‹ãƒ­ã‚°**    | `events`       | **E**vents                    | æœ€å¾Œã«ã‚¨ãƒ©ãƒ¼ã®äº‹å®Ÿã‚’æ´ã‚€        |

é ­æ–‡å­—ã®ä¸¦ã³ **C-S-S-R-P-S-E** ã‚’

> \*\*ã€Œ**C**hildren **S**ing **S**ongs, **R**abbits **P**lay **S**oft **E**choesã€

ã¨èªå‘‚åˆã‚ã›ã—ã¦ãŠãã¨ä¸€ç™ºã§æ€ã„å‡ºã›ã¾ã™ã€‚

---

#### ä½¿ã„æ–¹ä¾‹

```bash
kcfg neptune   # â† Namespace ã ã‘å¾Œã‚ã«ä»˜ã‘ã‚‹
```

å‡ºåŠ›ã‚’ä¸Šã‹ã‚‰é †ã«çœºã‚ã‚Œã°ã€
ã€Œè¨­å®š â†’ èªå¯ â†’ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ â†’ é€šä¿¡ â†’ ã‚¤ãƒ™ãƒ³ãƒˆã€ã®å…¸å‹ãƒˆãƒ©ãƒ–ãƒ«è¨ºæ–­ãƒ•ãƒ­ãƒ¼ãŒè‡ªç„¶ã«ãŸã©ã‚Œã¾ã™ã€‚


---

## 1. `kubectl run --command` ã®æµã‚Œ

| ãƒ•ã‚§ãƒ¼ã‚º                   | ã‚ªãƒ—ã‚·ãƒ§ãƒ³       | å½¹å‰²                            |
| ---------------------- | ----------- | ----------------------------- |
| **â‘  kubectl å´ã®è§£æçµ‚äº†**   | `--`        | ã“ã‚Œä»¥é™ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦æ‰±ã†           |
| **â‘¡ ã‚³ãƒ³ãƒ†ãƒŠ command ã‚’æ˜ç¤º** | `--command` | `command:` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è‡ªåˆ†ã§å®šç¾©ã™ã‚‹å®£è¨€    |
| **â‘¢ è¤‡æ•°ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ**         | `sh -c "â€¦"` | ã‚·ã‚§ãƒ«çµŒç”±ã§ `cmd1 && cmd2 â€¦` ã‚’ã¾ã¨ã‚ã‚‹ |

```bash
# ä¾‹: touch ã—ã¦ã‹ã‚‰ 1 æ—¥ã‚¹ãƒªãƒ¼ãƒ—ã™ã‚‹ Pod å®šç¾©ã‚’ YAML ç”Ÿæˆ
kubectl run pod6 \
  --image=busybox:1.31.0 \
  --dry-run=client -o yaml \
  --command -- sh -c "touch /tmp/ready && sleep 1d" \
> pod6.yaml
```

---

## 2. `sh` ã¨ `-c`

| ã‚­ãƒ¼   | èª¬æ˜                                 |
| ---- | ---------------------------------- |
| `sh` | POSIX Bourne shell (`/bin/sh`) ã‚’èµ·å‹• |
| `-c` | ç›´å¾Œã®æ–‡å­—åˆ—ã‚’ **ã‚¹ã‚¯ãƒªãƒ—ãƒˆ** ã¨ã—ã¦å®Ÿè¡Œ            |

```bash
sh -c "touch /tmp/ready && sleep 1d"
```

---

## 3. `readinessProbe.exec` ã®æ›¸ãæ–¹

### 3â€‘1. å˜ä¸€ãƒã‚¤ãƒŠãƒª

```yaml
readinessProbe:
  exec:
    command: ["cat", "/tmp/ready"]
```

### 3â€‘2. ã‚·ã‚§ãƒ«æ©Ÿèƒ½ãŒå¿…è¦ãªå ´åˆ

```yaml
readinessProbe:
  exec:
    command:
      - sh
      - -c
      - '[ -f /tmp/ready ] && echo OK || exit 1'
```

---

## 4. åŸºæœ¬ 3 ãƒ‘ã‚¿ãƒ¼ãƒ³æ—©è¦‹

| ãƒ‘ã‚¿ãƒ¼ãƒ³             | ä½¿ã„æ‰€                            | command ä¾‹                    |
| ---------------- | ------------------------------ | ---------------------------- |
| **ã‚·ãƒ³ãƒ—ãƒ«**         | å˜ä¸€ binï¼‹å¼•æ•°                      | `["cat","/tmp/ready"]`       |
| **è¤‡æ•°å‡¦ç† (ãƒ¡ã‚¤ãƒ³)**   | Pod `command:`                 | `["sh","-c","cmd1 && cmd2"]` |
| **è¤‡æ•°å‡¦ç† (Probe)** | `readinessProbe.exec.command:` | `["sh","-c","â€¦"]`            |

---

## 5. ç›´æ¥å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ä¾‹

```bash
kubectl run pod7 \
  --image=busybox:1.31.0 \
  --dry-run=client -o yaml \
  --command -- touch /tmp/ready \
> pod7.yaml
# â†’ command: ["touch","/tmp/ready"]
```

---

## 6. ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼

| ãƒ‹ãƒ¼ã‚º           | ã‚³ãƒãƒ³ãƒ‰                                     | å‚™è€ƒ                         |
| ------------- | ---------------------------------------- | -------------------------- |
| æ‰‹è»½ã«è¿½å¾“         | `k get po -w`                            | `-w/--watch` ã§ Event ã‚¹ãƒˆãƒªãƒ¼ãƒ  |
| ç”»é¢ä¸Šæ›¸ãï¼†é–“éš”æŒ‡å®š    | `watch -n2 k get po`                     | `watch` ã‚³ãƒãƒ³ãƒ‰å‰æ             |
| ã©ã“ã§ã‚‚å‹•ãæ±ç”¨ loop | `while true; do k get po; sleep 2; done` | bash ã•ãˆã‚ã‚Œã° OK              |

---

## 7. ServiceAccount ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—

### 7â€‘1. æ§‹æˆã‚’æŠŠæ¡

```bash
kubectl describe secret neptune-secret-1 -n neptune
# type: kubernetes.io/service-account-token ã‚’ç¢ºèª
# Data === ã« token / ca.crt / namespace
```

### 7â€‘2. token æŠ½å‡ºâ†’ãƒ‡ã‚³ãƒ¼ãƒ‰

```bash
kubectl get secret neptune-secret-1 -n neptune \
  -o jsonpath='{.data.token}' | base64 -d \
  > /opt/course/5/token
```

* `jsonpath` ã§ **Base64 ã®ã¾ã¾** å€¤ã‚’å–å¾— â‡’ **1 å›ã ã‘** `base64 -d`

#### ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ

| ç—‡çŠ¶                                                | åŸå› ã¨å¯¾ç­–                               |
| ------------------------------------------------- | ----------------------------------- |
| `template format specified but no template given` | `-o jsonpath` ã«ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’å¿˜ã‚ŒãŸ             |
| `base64: invalid input`                           | æ—¢ã« JWT ã«ãªã£ãŸæ–‡å­—åˆ—ã‚’å†åº¦ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼jsonpath ãŒç©ºæ–‡å­— |

---

> ã“ã‚Œã§ "å˜ä¸€ vs è¤‡æ•°ã‚³ãƒãƒ³ãƒ‰"ã€"Probe ã®æ›¸ãæ–¹"ã€"SA ãƒˆãƒ¼ã‚¯ãƒ³æŠœã"ã€"ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–" ã® 4 ã¤ã®å¼±ç‚¹ã‚’ãƒ¯ãƒ³ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ä¾‹ã‚„å›³ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã—ã‚‡ã† ğŸš€

---

## 8. Pod ã‚’åˆ¥ Namespace ã¸â€œç§»å‹•â€ã™ã‚‹

> **Note:** `metadata.namespace` ã¯ *immutable*ã€‚`kubectl edit` ã§æ›¸ãæ›ãˆã‚‹ã¨
> `the namespace from the provided object ... does not match` ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

### 8â€‘1. ãŠã™ã™ã‚æ‰‹é †

```bash
# å…ƒ Pod å®šç¾©ã‚’ãƒ€ãƒ³ãƒ—
kubectl get pod webserver-sat-003 -n saturn -o yaml > /tmp/pod.yaml

# namespace: saturn â†’ neptune ã«ç½®æ›
sed -i 's/namespace: saturn/namespace: neptune/' /tmp/pod.yaml

# é©ç”¨ï¼ˆæ–°ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã«ä½œæˆï¼‰
kubectl apply -f /tmp/pod.yaml

# æ—§ Pod ã‚’å‰Šé™¤ï¼ˆè¡çªé˜²æ­¢ï¼‰
kubectl delete pod webserver-sat-003 -n saturn
```

### 8â€‘2. ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼æ´¾

```bash
kubectl get pod webserver-sat-003 -n saturn -o yaml \
  | sed 's/namespace: saturn/namespace: neptune/' \
  | kubectl apply -f - && \
kubectl delete pod webserver-sat-003 -n saturn
```

### 8â€‘3. ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ & å›é¿ç­–

| ã‚¨ãƒ©ãƒ¼                            | åŸå›                                | è§£æ±ºç­–                              |
| ------------------------------ | -------------------------------- | -------------------------------- |
| `namespace ... does not match` | `kubectl edit` ã§ namespace ã‚’ç›´æ¥å¤‰æ›´ | *å†ä½œæˆ* ã§å¯¾å¿œ (`get` â†’ ç·¨é›† â†’ `apply`) |
| `already exists`               | åå‰è¡çªï¼ˆæ—§ Pod ãŒæ®‹ã£ã¦ã„ã‚‹ï¼‰               | å…ˆã« `kubectl delete`              |

---

## 9. `--record` ãƒ•ãƒ©ã‚°ã¨ã¯ï¼Ÿ

| è¦³ç‚¹                                      | èª¬æ˜                                                                                                                                  |
| --------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| ä½•ã‚’ã™ã‚‹ï¼Ÿ                                   | **å®Ÿè¡Œã—ãŸ kubectl ã‚³ãƒãƒ³ãƒ‰ã‚’ Deployment ã®å±¥æ­´ (`rollout history`) ã«æ®‹ã™**<br>â†’ PodTemplate ã«æ³¨é‡ˆ `kubernetes.io/change-cause: <ã‚³ãƒãƒ³ãƒ‰æ–‡å­—åˆ—>` ãŒè‡ªå‹•ä»˜ä¸ã•ã‚Œã‚‹ |
| ã©ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½¿ãˆã‚‹ï¼Ÿ                             | `kubectl create / apply / set image / set env / edit â€¦` ãªã©ã€<br>`spec.template` ã‚’å¤‰æ›´ã—ã†ã‚‹ã‚³ãƒãƒ³ãƒ‰ã«ä»˜ä¸å¯èƒ½                                      |
| åˆ©ç‚¹                                      | *ã‚ã¨ã‹ã‚‰èª°ãŒä½•ã‚’ã—ãŸã‹* ãŒå±¥æ­´ã§ä¸€ç›®ç­ç„¶ã«ãªã‚‹ï¼ˆç›£æŸ»ãƒ»ãƒ‡ãƒãƒƒã‚°å‘ã‘ï¼‰                                                                                                |
| ä¾‹                                       | \`\`\`bash                                                                                                                          |
| kubectl set image deploy/api-new-c32 \\ |                                                                                                                                     |
| backend=nginx:9.99-does-not-exist \\    |                                                                                                                                     |
| -n neptune --record                     |                                                                                                                                     |

# history ã« CHANGE-CAUSE ãŒæ®‹ã‚‹

kubectl rollout history deploy/api-new-c32 -n neptune

```|
| è£œè¶³ (K8s v1.18+)| `--record` ã¯éæ¨å¥¨ã€‚ä»£ã‚ã‚Šã«<br>`--annotation=kubernetes.io/change-cause="<msg>"` ã‚’ä½¿ã†ã¨æ˜ç¤ºçš„ã«æ®‹ã›ã‚‹ |

> **è¦šãˆæ–¹** : ã€Œ`--record` = *ã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜éŒ²*ã€ã€‚å±¥æ­´ã‚’èª­ã‚€æœªæ¥ã®è‡ªåˆ†ã®ãŸã‚ã«ä»˜ã‘ã¦ãŠãã¨å‰ã€‚

```
