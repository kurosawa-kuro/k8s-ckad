#!/bin/bash

# ======== 0. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ========
# å‰å›ã®æ§‹æˆã‚’å‰Šé™¤ã—ã¦ã€ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã§å†ã‚¹ã‚¿ãƒ¼ãƒˆ

kubectl delete -f deployment.yaml --ignore-not-found
kubectl delete secret ecr-registry-secret --namespace=ckad-ns --ignore-not-found
kubectl delete namespace ckad-ns --ignore-not-found
minikube delete --profile ckad-cluster

# ======== 1. ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼èµ·å‹• ========
minikube start --profile ckad-cluster
eval $(minikube docker-env)

# ======== 2. Namespace ä½œæˆãƒ»è¨­å®š ========
kubectl create namespace ckad-ns
kubectl config set-context --current --namespace=ckad-ns

# ======== 3. AWS ECR èªè¨¼ï¼šDockerãƒ­ã‚°ã‚¤ãƒ³ ========
aws ecr get-login-password --region ap-northeast-1 \
| docker login --username AWS \
  --password-stdin 986154984217.dkr.ecr.ap-northeast-1.amazonaws.com

# ======== 4. Kubernetes Secret ä½œæˆï¼ˆimagePullç”¨ï¼‰ ========
ECR_PASSWORD=$(aws ecr get-login-password --region ap-northeast-1)

kubectl create secret docker-registry ecr-registry-secret \
  --docker-server=986154984217.dkr.ecr.ap-northeast-1.amazonaws.com \
  --docker-username=AWS \
  --docker-password="$ECR_PASSWORD" \
  --namespace=ckad-ns

# ======== 5. ç¢ºèª ========
kubectl config current-context
kubectl cluster-info

kubectl get ns
kubectl config view --minify | grep namespace













äº†è§£ï¼ä»¥ä¸‹ã«ã€**minikubeãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‹ã‚‰ECRèªè¨¼ã®Kubernetesã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä½œæˆã¾ã§ã‚’æ•´ç†ã—ãŸå®Œå…¨ã‚¬ã‚¤ãƒ‰**ã‚’ã¾ã¨ã‚ã¾ã—ãŸğŸ‘‡  
CKADã®ç·´ç¿’ç’°å¢ƒã‚„ECRé€£æºPoCã«ã‚‚ãã®ã¾ã¾ä½¿ãˆã¾ã™ğŸ”¥

---

# âœ… Kubernetes Ã— minikube Ã— ECR èªè¨¼è¨­å®šã‚¬ã‚¤ãƒ‰

---

## ğŸ”¹ 1. ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ç®¡ç†

### âœ… ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®ç¢ºèª

```bash
minikube profile list
```

### âœ… æ—¢å­˜ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹ï¼šckad-clusterï¼‰ã®å‰Šé™¤ã¨å†ä½œæˆ

```bash
minikube delete --profile ckad-cluster
minikube start --profile ckad-cluster
```

â€»ç·´ç¿’ã®åˆæœŸåŒ–ã¨ã—ã¦æœ‰åŠ¹

---

## ğŸ”¹ 2. `kubectl` ã®æ¥ç¶šå…ˆç¢ºèª

### âœ… ç¾åœ¨ã® `kubectl` context ã¨ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±ã‚’ç¢ºèª

```bash
kubectl config current-context
kubectl cluster-info
```

â†’ `minikube` ã¾ãŸã¯ `ckad-cluster` ã®ã‚ˆã†ãª context ãŒè¿”ã‚Œã°OK

---

## ğŸ”¹ 3. Dockerã¨ECRé€£æºã®æº–å‚™ï¼ˆminikubeå†…ã§ãƒ“ãƒ«ãƒ‰ or ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹å ´åˆï¼‰

### âœ… Dockerç’°å¢ƒã‚’minikubeã«åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆãƒ›ã‚¹ãƒˆ â†’ minikubeï¼‰

```bash
eval $(minikube docker-env)
```

---

## ğŸ”¹ 4. AWS ECR èªè¨¼ï¼†Kubernetes Secretä½œæˆ

### âœ… ECRãƒ­ã‚°ã‚¤ãƒ³ï¼ˆç›´æ¥ãƒ­ã‚°ã‚¤ãƒ³ï¼‰

```bash
aws ecr get-login-password --region ap-northeast-1 \
| docker login --username AWS --password-stdin 986154984217.dkr.ecr.ap-northeast-1.amazonaws.com
```

### âœ… Kubernetes Secretä½œæˆï¼ˆPodã§ECRã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’pullã™ã‚‹ãŸã‚ï¼‰

```bash
# 1. èªè¨¼æƒ…å ±ã‚’å¤‰æ•°ã«ä¿å­˜
ECR_PASSWORD=$(aws ecr get-login-password --region ap-northeast-1)

# 2. Secretä½œæˆ
kubectl create secret docker-registry ecr-registry-secret \
  --docker-server=986154984217.dkr.ecr.ap-northeast-1.amazonaws.com \
  --docker-username=AWS \
  --docker-password="$ECR_PASSWORD"
```

### âœ… Secretä½¿ç”¨ä¾‹ï¼ˆPodå†…ã§pullã™ã‚‹å ´åˆã®YAMLä¸€éƒ¨ï¼‰

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ecr-pod
spec:
  containers:
    - name: app
      image: 986154984217.dkr.ecr.ap-northeast-1.amazonaws.com/my-app:latest
  imagePullSecrets:
    - name: ecr-registry-secret
```

---

## ğŸ§¼ è£œè¶³

- `kubectl delete secret ecr-registry-secret` ã§å‰Šé™¤å¯èƒ½
- `--namespace=<name>` ä»˜ãã§Secretã‚’åˆ¥Namespaceã«ä½œæˆã™ã‚‹ã“ã¨ã‚‚OK

---

## ğŸ¯ ç·´ç¿’ã‚µã‚¤ã‚¯ãƒ«ä¾‹ï¼ˆæœ€çŸ­æ‰‹é †ï¼‰

```bash
minikube delete --profile ckad-cluster
minikube start --profile ckad-cluster

eval $(minikube docker-env)

aws ecr get-login-password --region ap-northeast-1 \
| docker login --username AWS --password-stdin 986154984217.dkr.ecr.ap-northeast-1.amazonaws.com

# 1. èªè¨¼æƒ…å ±ã‚’å¤‰æ•°ã«ä¿å­˜
ECR_PASSWORD=$(aws ecr get-login-password --region ap-northeast-1)

# 2. Secretä½œæˆ
kubectl create secret docker-registry ecr-registry-secret \
  --docker-server=986154984217.dkr.ecr.ap-northeast-1.amazonaws.com \
  --docker-username=AWS \
  --docker-password="$ECR_PASSWORD"

kubectl create namespace ckad-ns
kubectl config set-context --current --namespace=ckad-ns

# ä»¥é™ã€Deployment â†’ Service â†’ ECRé€£æºPodã‚’é©ç”¨
```

---

ã“ã®æ§‹æˆã§ã€**CKADç·´ç¿’ãƒ»ECRé€£æºãƒ»å®Ÿç’°å¢ƒæ¨¡æ“¬**ã®å…¨éƒ¨ã«å¯¾å¿œã§ãã¾ã™ğŸ™†â€â™‚ï¸  
å¿…è¦ãªã‚‰ã€Œ`imagePullSecrets` ã‚’å«ã‚“ã Deploymentãƒ†ãƒ³ãƒ—ãƒ¬ã€ã‚‚å‡ºã™ã‚ˆï¼ã‚„ã‚‹ï¼ŸğŸ”¥