### â€œç·´ç¿’è–„ã„ã‚¾ãƒ¼ãƒ³â€ ã‚’ **2 é€±é–“ã§æ½°ã™** é›†ä¸­ãƒ‘ã‚¿ãƒ¼ãƒ³é›†

> **åŸå‰‡**ï¼š1 æ—¥ 40 åˆ† Ã—14 æ—¥ï¼9 h å¼·  
> **ãƒ¡ã‚½ãƒƒãƒ‰**ï¼š
> 
> 1. _é››å½¢ YAMLï¼ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã‚’å…ˆã«ç”¨æ„_ï¼ˆæ‰“éµã‚’æ€è€ƒã‹ã‚‰åˆ‡ã‚Šé›¢ã™ï¼‰
>     
> 2. _ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã§çŸ­è·é›¢åå¾©_ï¼ˆ4â€Šåˆ†ä»¥å†… Ã—3 æœ¬ï¼‰
>     
> 3. _`kubectl diff / rollout status / can-i` ã§å¿…ãšç¢ºèª_
>     

---

## 1 æ—¥ç›®ï¼š**Docker image** â€• 60 ç§’ãƒ“ãƒ«ãƒ‰ã‚»ãƒƒãƒˆ

|Drill|ã‚³ãƒãƒ³ãƒ‰|ã‚¿ã‚¤ãƒ ç›®æ¨™|
|---|---|---|
|**Build â†’ Tag â†’ Push**|```bash||
|docker build -t lab:v1 .|||
|docker tag lab:v1 localhost:5000/lab:v1|||
|docker push localhost:5000/lab:v1|||

````|
| **Save / Export** | `docker save lab:v1 -o /tmp/lab.tar` | **â‰¤ 30 s** |
| **å‹•ä½œç¢ºèª** | `docker run --rm lab:v1 echo ok` | **â‰¤ 30 s** |

> ğŸ”„ 3 ã‚»ãƒƒãƒˆã€‚3 å›ã« 1 å›ã¯ `Dockerfile` ã‚’ 1 è¡Œæ›¸ãæ›ãˆã¦å†ãƒ“ãƒ«ãƒ‰ã€‚

---

## 2â€“3 æ—¥ç›®ï¼š**Canary + scale / patch** â€• 4 æ‰‹ã‚³ãƒ³ãƒœ

1. `k get deploy payment -o yaml > canary.yaml` â†’ *nameãƒ»labelsãƒ»replicas=1* ã¸æ›¸æ›  
2. `k apply -f canary.yaml`  
3. `k scale deploy payment --replicas=4; k scale deploy payment-canary --replicas=1`  
4. `k patch deploy payment-canary -p '{"spec":{"template":{"spec":{"containers":[{"name":"app","image":"repo:v3-canary"}]}}}}'`

**ç›®æ¨™**ï¼šã‚³ãƒ”ãƒšè¾¼ã¿ **3 åˆ†å®Œçµ Ã—5 å‘¨**ï¼ˆãƒ¬ã‚·ãƒ”ã‚’æŒ‡ã«ç„¼ãä»˜ã‘ï¼‰ã€‚

---

## 4 æ—¥ç›®ï¼š**RollingUpdate** å˜ä¸€ Deployment é€Ÿæ”»

```bash
k set image deploy api api=repo:v2
k patch deploy api -p '{
 "spec":{"strategy":{"type":"RollingUpdate",
  "rollingUpdate":{"maxSurge":"20%","maxUnavailable":0}}}}'
k rollout status deploy api
````

_3 å›é€£ç¶šã§ **120 s** åˆ‡ã‚ŒãŸã‚‰ OKã€‚_

---

## 5 æ—¥ç›®ï¼š**Probes 3 å…„å¼Ÿ** â€• ã‚³ãƒ”ãƒšæ ã‚’ä½œã‚‹ã ã‘

```yaml
livenessProbe:   { httpGet: {path: /healthz, port: 8080}, periodSeconds: 10 }
readinessProbe:  { httpGet: {path: /ready,   port: 8080}, periodSeconds: 5 }
startupProbe:    { httpGet: {path: /ready,   port: 8080}, failureThreshold: 30, periodSeconds: 2 }
```

1. ä¸Šè¨˜ãƒ–ãƒ­ãƒƒã‚¯ã‚’ **snippet.txt** ã«ä¿å­˜
    
2. `k edit deploy web` â†’ æœ€ä¸Šéƒ¨ã®ã‚³ãƒ³ãƒ†ãƒŠã«è²¼ã‚Šä»˜ã‘
    
3. `k rollout status` ã§ Ready/NotReady ã®æ¨ç§»ã‚’ç›®è¦–
    

> ğŸ”„ 5 Pod ã¸ä¸€æ‹¬è²¼ã‚Š â†’ **5 min** ã§æ§‹æ–‡ãŒèº«ä½“ã«å®šç€ã€‚

---

## 6â€“7 æ—¥ç›®ï¼š**SecurityContext & RBAC**

|ã‚¿ã‚¹ã‚¯|ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼|
|---|---|
|**é root å¼·åˆ¶**|`k patch deploy api -p '{"spec":{"template":{"spec":{"securityContext":{"runAsNonRoot":true,"runAsUser":1001}}}}}'`|
|**capability å…¨ drop**|`k patch deploy api -p '{"spec":{"template":{"spec":{"containers":[{"name":"app","securityContext":{"capabilities":{"drop":["ALL"]}}}]}}}}'`|
|**Role & Binding**|```bash|
|k create role pod-r --verb=get,list --resource=pods -n dev -o yaml --dry-run=client|k apply -f -|
|k create rolebinding pod-rb --role=pod-r --serviceaccount=dev:app-sa -n dev -o yaml --dry-run=client|k apply -f -|
|k auth can-i list pods --as=system:serviceaccount:dev:app-sa -n dev||

````|

**3 ã‚»ãƒƒãƒˆ**ã§ â€œUID + drop ALL + bindingâ€ ãŒé ­ã«æ®‹ã‚Œã°ååˆ†ã€‚

---

## 8 æ—¥ç›®ï¼š**Taints / Tolerations** â€• æœ€å°å®Ÿæ¼”ã ã‘

```bash
k taint node $(k get no -o name |head -1) gpu=true:NoSchedule
````

Deployment 1 â†’ `Pending` ã‚’ç¢ºèª  
Deployment 2 â†’ `spec.template.spec.tolerations` ã«

```yaml
- key: gpu
  operator: Equal
  value: "true"
  effect: NoSchedule
```

â†’ **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æˆåŠŸã‚’ç¢ºèª**ã€‚  
_1 åº¦ã‚„ã‚Œã°æ§‹é€ ã¯ OKã€‚æ‰€è¦ 15 minã€‚_

---

## 9â€“10 æ—¥ç›®ï¼š**NetworkPolicy** â€œç™½ãƒ»é»’â€ ãƒšã‚¢

|ç›®çš„|YAML ã‚¹ãƒ‹ãƒšãƒƒãƒˆï¼ˆè¦šãˆã‚‹è¡Œã ã‘ï¼‰|
|---|---|
|**åŒ NS å†… 80/TCP ã ã‘è¨±å¯**|```yaml|
|kind: NetworkPolicy||
|spec:||
|podSelector: {matchLabels:{app:web}}||
|ingress:||

- from:
    
    - podSelector: {} # å…¨ Pod  
        ports: [{protocol:TCP,port:80}]
        

````|
| **å…¨ egress ã‚’ç¦æ­¢** | ```yaml
policyTypes: ["Egress"]
egress: []    # ç©ºãƒªã‚¹ãƒˆã§ deny-all
``` |

*apply â†’ `kubectl exec curl` ã§ç–é€šãƒ†ã‚¹ãƒˆã‚’ 3 ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚30 min ã§å®Œäº†ã€‚*

---

## 11â€“12 æ—¥ç›®ï¼š**killer.sh æ¨¡è©¦ (æ™‚é–“ç„¡åˆ¶é™)**  
- è½ã¨ã—ãŸã®ãŒ **ç·´ç¿’è–„ã‚¾ãƒ¼ãƒ³** ã‹ç¢ºèªã€‚  
- YAML é››å½¢ã‚’ snippet é›†ã¸è¿½è¨˜ã€‚

---

## 13â€“14 æ—¥ç›®ï¼š**æ¨¡è©¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ 90 min**  
ç›®æ¨™ **60 %**ï¼šé”æˆã—ãŸã‚‰å³æœ¬ç•ªäºˆç´„ã€å±Šã‹ãªã‘ã‚Œã°è½ã¨ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã ã‘ç¿Œé€±è¿½åŠ  1 ã‚¹ãƒ—ãƒªãƒ³ãƒˆã€‚

---

### è£œåŠ©ãƒ„ãƒ¼ãƒ«ï¼ˆä»»æ„ï¼‰

| ãƒ„ãƒ¼ãƒ« | å½¹å‰² |
|--------|-----|
| **k alias** | `alias k='kubectl --namespace=$(cat /var/run/secrets/.../namespace)'` |
| **yq** | `yq e '.spec.template.spec.securityContext.runAsNonRoot=true' d.yaml | k apply -f -` |
| **fzf** | `export FZF_DEFAULT_COMMAND='kubectl get pods --no-headers'` ã§ Pod åè£œå®Œ |

---

ã“ã‚Œã§ **ç·´ç¿’ä¸è¶³ã‚¾ãƒ¼ãƒ³ã‚’ 2 é€±é–“ã§ä¸€æ°—ã«æ‰‹ç™–åŒ–** ã§ãã¾ã™ã€‚  
é€²ã‚ãªãŒã‚‰è©°ã¾ã£ãŸç®‡æ‰€ã‚„ã‚¿ã‚¤ãƒ ãŒç¸®ã¾ã‚‰ãªã„ç®‡æ‰€ãŒå‡ºã¦ããŸã‚‰ã€ã¾ãŸãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§è³ªå•ã—ã¦ãã ã•ã„ã­ã€‚
````